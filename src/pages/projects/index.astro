---
// Detailed Explanation: This is the main dashboard page for viewing all projects.
// It fetches the list of projects from the database on the server side working with ProjectService.
// Additionaly, it renders the UI for searching through projects, displaying them in a grid,
// and searching for them. It also includes the 'Create Project' modal form.
import AppLayout from "../../layouts/AppLayout.astro";
import Card from "../../components/ui/Card.astro";
import Button from "../../components/ui/Button.astro";
import Badge from "../../components/ui/Badge.astro";
import Modal from "../../components/ui/Modal.astro";
import Input from "../../components/ui/Input.astro";
import { ProjectService } from "../../lib/services/project.service";

const projects = await ProjectService.getAllProjects();
---

<AppLayout>
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"
  >
    <div>
      <h1 class="text-3xl font-bold text-ink-900 dark:text-white mb-1">
        Projects
      </h1>
      <p class="text-ink-500 dark:text-ink-400">Manage your agile workspaces</p>
    </div>
    <div class="flex gap-3">
      <div class="relative">
        <input
          id="project-search"
          type="text"
          placeholder="Search projects..."
          class="pl-10 pr-4 py-2.5 rounded-2xl border-none ring-1 ring-ink-100 dark:ring-ink-700 bg-white dark:bg-ink-800 dark:text-white focus:ring-2 focus:ring-peach-300 outline-none w-64 shadow-sm placeholder:text-ink-300 dark:placeholder:text-ink-500"
        />
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 absolute left-3 top-3 text-ink-300"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
      <Button
        onclick="document.getElementById('create_project_modal').showModal()"
        >Create Project</Button
      >
    </div>
  </div>

  {
    projects.length === 0 ? (
      <div class="text-center py-20 bg-white rounded-3xl border-2 border-dashed border-ink-100 p-4">
        <div class="w-16 h-16 bg-peach-50 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-peach-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-ink-900 mb-1">No projects yet</h3>
        <p class="text-ink-400 mb-6">
          Create your first project to get started
        </p>
        <Button onclick="document.getElementById('create_project_modal').showModal()">
          Create Project
        </Button>
      </div>
    ) : (
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        id="projects-grid"
      >
        {projects.map((project: any) => (
          <a
            href={`/projects/${project._id}`}
            class="block group project-card"
            data-name={project.name.toLowerCase()}
          >
            <Card class="h-full hover:shadow-lg transition-all border border-transparent hover:border-peach-200">
              <div class="flex justify-between items-start mb-4">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-peach-100 to-peach-50 flex items-center justify-center text-peach-600 font-bold text-lg shadow-inner">
                  {project.name.charAt(0).toUpperCase()}
                </div>
                <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 text-ink-300 hover:text-ink-600"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                    />
                  </svg>
                </div>
              </div>

              <h3 class="text-lg font-semibold text-ink-900 dark:text-white mb-2 truncate group-hover:text-peach-600 transition-colors">
                {project.name}
              </h3>
              <p class="text-ink-500 dark:text-ink-400 text-sm line-clamp-2 mb-4 h-10">
                {project.description || "No description provided"}
              </p>

              <div class="flex items-center justify-between border-t border-ink-50 dark:border-ink-700 pt-4 mt-auto">
                <Badge label="Active" variant="success" />
                <span class="text-xs text-ink-400 dark:text-ink-500 font-medium">
                  Updated just now
                </span>
              </div>
            </Card>
          </a>
        ))}
      </div>
    )
  }

  <Modal id="create_project_modal" title="Create New Project">
    <form id="create_project_form" class="space-y-6">
      <Input
        name="name"
        label="Project Name"
        placeholder="e.g. Website Redesign"
        required
      />
      <Input
        name="repositoryUrl"
        label="Git Repository URL (Optional)"
        placeholder="https://github.com/..."
      />
      <Input
        name="description"
        label="Description (Optional)"
        placeholder="Brief description..."
      />

      <div class="flex justify-end gap-3 pt-2">
        <Button
          variant="ghost"
          type="button"
          onclick="document.getElementById('create_project_modal').close()"
          >Cancel</Button
        >
        <Button type="submit">Create Project</Button>
      </div>
    </form>
  </Modal>
</AppLayout>

<script>
  const form = document.getElementById("create_project_form");
  const searchInput = document.getElementById("project-search");

  // Search functionality
  searchInput?.addEventListener("input", (e) => {
    const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
    const cards = document.querySelectorAll(".project-card");

    cards.forEach((card) => {
      const name = card.getAttribute("data-name") || "";
      if (name.includes(searchTerm)) {
        (card as HTMLElement).style.display = "block";
      } else {
        (card as HTMLElement).style.display = "none";
      }
    });
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    const data = Object.fromEntries(formData);

    try {
      const res = await fetch("/api/projects", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        window.location.reload();
      } else {
        alert("Failed to create project");
      }
    } catch (err) {
      console.error(err);
      alert("Error creating project");
    }
  });
</script>
